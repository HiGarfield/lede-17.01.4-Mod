From f20bb89bd23083cae30408b71a1aa08d2ced685b Mon Sep 17 00:00:00 2001
From: HiGarfield <HiGarfield@126.com>
Date: Tue, 18 Nov 2025 22:50:11 +0800
Subject: [PATCH] fix build errors on older platforms

---
 src/config.c    |  4 ++++
 src/dhcpv6-ia.c |  1 +
 src/odhcpd.c    |  4 +++-
 src/odhcpd.h    | 16 ++++++++--------
 4 files changed, 16 insertions(+), 9 deletions(-)

--- a/src/config.c
+++ b/src/config.c
@@ -943,6 +943,7 @@ static int parse_dnr_str(char *str, stru
 
 		switch (svc_key) {
 		case DNR_SVC_MANDATORY:
+			;
 			uint16_t mkeys[DNR_SVC_MAX];
 
 			svc_val_len = 0;
@@ -976,6 +977,7 @@ static int parse_dnr_str(char *str, stru
 			break;
 
 		case DNR_SVC_ALPN:
+			;
 			size_t len_off;
 
 			tmp = realloc(dnr.svc, dnr.svc_len + 4);
@@ -1014,6 +1016,7 @@ static int parse_dnr_str(char *str, stru
 			break;
 
 		case DNR_SVC_PORT:
+			;
 			uint16_t port;
 
 			if (sscanf(svc_val_str, "%" SCNu16, &port) != 1) {
@@ -1076,6 +1079,7 @@ static int parse_dnr_str(char *str, stru
 	}
 
 done:
+	;
 	struct dnr_options *tmp;
 	tmp = realloc(iface->dnr, (iface->dnr_cnt + 1) * sizeof(dnr));
 	if (!tmp)
--- a/src/dhcpv6-ia.c
+++ b/src/dhcpv6-ia.c
@@ -1127,6 +1127,7 @@ ssize_t dhcpv6_ia_handle_IAs(uint8_t *bu
 		}
 
 proceed:
+		;
 		/* Generic message handling */
 		uint16_t status = DHCPV6_STATUS_OK;
 
--- a/src/odhcpd.c
+++ b/src/odhcpd.c
@@ -36,6 +36,7 @@
 #include <sys/socket.h>
 #include <sys/ioctl.h>
 #include <sys/epoll.h>
+#include <sys/stat.h>
 #include <sys/types.h>
 #include <sys/wait.h>
 #include <sys/syscall.h>
@@ -114,6 +115,7 @@ int main(int argc, char **argv)
 	while ((opt = getopt(argc, argv, "c:l:fh")) != -1) {
 		switch (opt) {
 		case 'c':
+			;
 			struct stat sb;
 			char *path;
 
@@ -559,7 +561,7 @@ void odhcpd_urandom(void *data, size_t l
 		if (len == 0)
 			return;
 
-		r = getrandom(data, len, GRND_INSECURE);
+		r = getrandom(data, len, 0);
 		if (r < 0) {
 			if (errno == EINTR)
 				continue;
--- a/src/odhcpd.h
+++ b/src/odhcpd.h
@@ -77,14 +77,14 @@ extern struct config config;
 extern struct sys_conf sys_conf;
 
 void __iflog(int lvl, const char *fmt, ...);
-#define debug(fmt, ...) __iflog(LOG_DEBUG, fmt __VA_OPT__(, ) __VA_ARGS__)
-#define info(fmt, ...) __iflog(LOG_INFO, fmt __VA_OPT__(, ) __VA_ARGS__)
-#define notice(fmt, ...) __iflog(LOG_NOTICE, fmt __VA_OPT__(, ) __VA_ARGS__)
-#define warn(fmt, ...) __iflog(LOG_WARNING, fmt __VA_OPT__(, ) __VA_ARGS__)
-#define error(fmt, ...) __iflog(LOG_ERR, fmt __VA_OPT__(, ) __VA_ARGS__)
-#define critical(fmt, ...) __iflog(LOG_CRIT, fmt __VA_OPT__(, ) __VA_ARGS__)
-#define alert(fmt, ...) __iflog(LOG_ALERT, fmt __VA_OPT__(, ) __VA_ARGS__)
-#define emergency(fmt, ...) __iflog(LOG_EMERG, fmt __VA_OPT__(, ) __VA_ARGS__)
+#define debug(fmt, ...) __iflog(LOG_DEBUG, fmt, ##__VA_ARGS__)
+#define info(fmt, ...) __iflog(LOG_INFO, fmt, ##__VA_ARGS__)
+#define notice(fmt, ...) __iflog(LOG_NOTICE, fmt, ##__VA_ARGS__)
+#define warn(fmt, ...) __iflog(LOG_WARNING, fmt, ##__VA_ARGS__)
+#define error(fmt, ...) __iflog(LOG_ERR, fmt, ##__VA_ARGS__)
+#define critical(fmt, ...) __iflog(LOG_CRIT, fmt, ##__VA_ARGS__)
+#define alert(fmt, ...) __iflog(LOG_ALERT, fmt, ##__VA_ARGS__)
+#define emergency(fmt, ...) __iflog(LOG_EMERG, fmt, ##__VA_ARGS__)
 
 
 struct odhcpd_event {
