From 0a4251e6b290af64ae3832bf0469b7699c2cae66 Mon Sep 17 00:00:00 2001
From: Nick Peng <pymumu@gmail.com>
Date: Thu, 19 Jun 2025 22:51:58 +0800
Subject: [PATCH] mdns: add ipv6 support.

---
 src/dns_client.c | 29 +++++++++++++++++------------
 src/dns_client.h |  2 ++
 2 files changed, 19 insertions(+), 12 deletions(-)

--- a/src/dns_client.c
+++ b/src/dns_client.c
@@ -2291,7 +2291,7 @@ static int _dns_client_create_socket_udp
 	const int priority = SOCKET_PRIORITY;
 	const int ip_tos = SOCKET_IP_TOS;
 
-	fd = socket(AF_INET, SOCK_DGRAM, 0);
+	fd = socket(server_info->ai_family, SOCK_DGRAM, 0);
 	if (fd < 0) {
 		tlog(TLOG_ERROR, "create socket failed, %s", strerror(errno));
 		goto errout;
@@ -4077,7 +4077,9 @@ static int _dns_client_send_packet(struc
 					_dns_server_inc_prohibit_server_num(server_info);
 					time(&server_info->last_send);
 					time(&server_info->last_recv);
-					tlog(TLOG_INFO, "server %s not alive, prohibit", server_info->ip);
+					if (server_info->type != DNS_SERVER_MDNS) {
+						tlog(TLOG_INFO, "server %s not alive, prohibit", server_info->ip);
+					}
 					_dns_client_shutdown_socket(server_info);
 				}
 
@@ -5002,7 +5004,7 @@ static int _dns_client_add_mdns_server(v
 			continue;
 		}
 
-		if (AF_INET != ifa->ifa_addr->sa_family) {
+		if (AF_INET != ifa->ifa_addr->sa_family && AF_INET6 != ifa->ifa_addr->sa_family) {
 			continue;
 		}
 
@@ -5019,16 +5021,19 @@ static int _dns_client_add_mdns_server(v
 		}
 
 		safe_strncpy(server_flags.ifname, ifa->ifa_name, sizeof(server_flags.ifname));
-		ret = _dns_client_server_add(DNS_MDNS_IP, "", DNS_MDNS_PORT, DNS_SERVER_MDNS, &server_flags);
-		if (ret != 0) {
-			tlog(TLOG_ERROR, "add mdns server failed.");
-			goto errout;
-		}
+		char *dns_ip[] = {DNS_MDNS_IP, DNS_MDNS_IP6, 0};
+		for (int i = 0; dns_ip[i] != NULL; i++) {
+			ret = _dns_client_server_add(dns_ip[i], "", DNS_MDNS_PORT, DNS_SERVER_MDNS, &server_flags);
+			if (ret != 0) {
+				tlog(TLOG_ERROR, "add mdns server failed for %s.", dns_ip[i]);
+				goto errout;
+			}
 
-		if (dns_client_add_to_group(DNS_SERVER_GROUP_MDNS, DNS_MDNS_IP, DNS_MDNS_PORT, DNS_SERVER_MDNS,
-									&server_flags) != 0) {
-			tlog(TLOG_ERROR, "add mdns server to group failed.");
-			goto errout;
+			if (dns_client_add_to_group(DNS_SERVER_GROUP_MDNS, dns_ip[i], DNS_MDNS_PORT, DNS_SERVER_MDNS,
+										&server_flags) != 0) {
+				tlog(TLOG_ERROR, "add mdns server to group failed for %s.", dns_ip[i]);
+				goto errout;
+			}
 		}
 	}
 
--- a/src/dns_client.h
+++ b/src/dns_client.h
@@ -32,9 +32,11 @@ extern "C" {
 #define DNS_SERVER_GROUP_LOCAL "local"
 #ifdef TEST
 #define DNS_MDNS_IP "127.0.0.1"
+#define DNS_MDNS_IP6 "::1"
 #define DNS_MDNS_PORT 55353
 #else
 #define DNS_MDNS_IP "224.0.0.251"
+#define DNS_MDNS_IP6 "ff02::fb"
 #define DNS_MDNS_PORT 5353
 #endif
 
