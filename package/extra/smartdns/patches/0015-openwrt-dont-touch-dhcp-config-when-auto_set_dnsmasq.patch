From bf37c56e7c39c822a0a722a77a4496a910135845 Mon Sep 17 00:00:00 2001
From: rhjdvsgsgks <26178113+rhjdvsgsgks@users.noreply.github.com>
Date: Thu, 26 Jun 2025 22:27:40 +0000
Subject: [PATCH] openwrt: dont touch dhcp config when auto_set_dnsmasq set

even may have port conflict
---
 package/openwrt/files/etc/init.d/smartdns | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

--- a/package/openwrt/files/etc/init.d/smartdns
+++ b/package/openwrt/files/etc/init.d/smartdns
@@ -806,7 +806,7 @@ load_service()
 	# disable service
 	[ "$enabled" = "0" ] && {
 		[ "$old_enabled" = "0" ] && return 1
-		[ "$old_port" = "53" ] && stop_main_dns "0"
+		[ "$old_port" = "53" ] && [ "$old_auto_set_dnsmasq" = "1" ] && stop_main_dns "0"
 		[ "$old_port" != "53" ] && [ "$old_auto_set_dnsmasq" = "1" ] && stop_forward_dnsmasq "$old_port" "0"
 		disable_auto_update
 		return 1
@@ -817,13 +817,16 @@ load_service()
 		[ "$old_port" = "53" ] && {
 			no_restart_dnsmasq="1"
 			[ "$auto_set_dnsmasq" = "0" ] && no_restart_dnsmasq="0"
-			stop_main_dns "$no_restart_dnsmasq"
+			[ "$old_auto_set_dnsmasq" = "1" ] && stop_main_dns "$no_restart_dnsmasq"
 		}
 		[ "$old_port" != "53" ] && [ "$old_auto_set_dnsmasq" = "1" ] && stop_forward_dnsmasq "$old_port" "1"
 	}
 
 	# start service
-	[ "$port" = "53" ] && set_main_dns
+	[ "$port" = "53" ] && {
+		[ "$auto_set_dnsmasq" = "1" ] && set_main_dns
+		[ "$auto_set_dnsmasq" = "0" ] && [ "$old_auto_set_dnsmasq" = "1" ] && stop_main_dns "0"
+	}
 	[ "$port" != "53" ] && {
 		[ "$auto_set_dnsmasq" = "1" ] && set_forward_dnsmasq "$port"
 		[ "$auto_set_dnsmasq" = "0" ] && [ "$old_auto_set_dnsmasq" = "1" ] && stop_forward_dnsmasq "$old_port" "0"
@@ -898,7 +901,7 @@ unload_service()
 
 	[ "$enabled" = "1" ] && {
 		[ "$old_enabled" = "0" ] && return 1
-		[ "$old_port" = "53" ] && stop_main_dns "0"
+		[ "$old_port" = "53" ] && [ "$old_auto_set_dnsmasq" = "1" ] && stop_main_dns "0"
 		[ "$old_port" != "53" ] && [ "$old_auto_set_dnsmasq" = "1" ] && stop_forward_dnsmasq "$old_port" "0"
 	}
 }
